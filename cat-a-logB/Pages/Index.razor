@page "/";
@using cat_a_logB.Data
@using cat_a_logB;
@using ApexCharts;
@using Microsoft.AspNetCore.Components;
@using Service;
@inject cat_a_logB.Pages.SampleData SampleData
@inject cat_a_logB.Data.TaskManager TaskManager
@inject Service.ITaskDataService TaskDataService
@inject Service.IDependencyService DependencyService
@inject Service.IMilestoneService MilestoneService
@inject Service.IProjectTeamService ProjectTeamService


<PageTitle>Gantt Chart</PageTitle>

@* <button type="button" class="btn btn-primary" @onclick=ShowMilestones>Show Milestones</button> *@

<DemoContainer>
    <ApexChart @ref=MileChart TItem="ProjectMilestone" Title="@title" Height="120" Options=options1 Debug OnClick=HandleMilestoneClick>
    

        <ApexPointTooltip>
            <div class="m-2" style="width: 300px; max-height: 100px; font-size: 12px;">
                @if (context != null)
                {
                    var dataPoint = (ApexCharts.DataPoint<ProjectMilestone>)context.DataPoint;

                    var milestone = dataPoint.Items.FirstOrDefault();
                    if (milestone != null)
                    {
                        <h4>@milestone.Name</h4>
                        <span>Tasks:</span>
                        <ul>
                            @foreach (var task in milestone.Tasks)
                            {
                                <li>
                                    <span style="margin-right: 8px;">@task.Name</span>
                                    @if (task.Progress == 100)
                                    {
                                        <span style="color: green;">(Complete)</span>
                                    }


                                </li>

                            }
                        </ul>
                        
                    }
                }
                else
                {
                    <p>Context is null.</p>
                }

            </div>
        </ApexPointTooltip>


        <ChildContent>

            <ApexPointSeries TItem="ProjectMilestone" Items="milestones" Name="Milestones" SeriesType="SeriesType.Line"
                XValue="@(e => e.Name)" YValue="@(e => 0)" PointColor="@(e => e.Color)">


            </ApexPointSeries>

        </ChildContent>

    </ApexChart>

</DemoContainer>





<DemoContainer>

    @if (project == null)
    {
        <div class="text-center text-muted" style="min-height: 300px">
            <h3>Loading chart<span class="animated-dots"></span></h3>
        </div>
    }
    else
    {

        <ApexChart OnClick=OnClick @ref=chart TItem="TaskData" Title="Project Gantt chart" Options="options"

            XAxisType="XAxisType.Datetime">
             

            <ApexPointTooltip>

                <div class="m-3">
                    @{
                        var point = (ListPoint<TaskData>)context.DataPoint;
                        var task = point.Items.First();

                        <h4>@point.X</h4>
                        <span>Deadline: @point.Items.First().EndDate.ToShortDateString()</span>
                        <br>
                        <span>Team: @point.Items.First().Team.Name</span>
                        <br>
                        <span>@CompareUserProgress(point.Items.First())</span>
                        <br>
                        @if (task.Progress == 0)
                        {
                            <span style="color: red;">Task has zero progress.</span>
                        }
                        else if (task.Progress >= task.AutoProgress)
                        {
                            <span style="color: green;">@CheckEstimatedProgress(point.Items.First())</span>
                        }
                        else
                        {
                            <span style="color: red;">@CheckEstimatedProgress(point.Items.First())</span>
                        }
                    }
                </div>

            </ApexPointTooltip>

            <ChildContent>
                @foreach (var team in teams)
                {
                    <ApexRangeSeries TItem="TaskData" Items="project.Where(task => task.Team == team)" Name="@team.Name"
                        XValue="@(e => e.Name)" YMinValue="@(e => e.StartDate.ToUnixTimeMilliseconds())"
                        YMaxValue="@(e => e.EndDate.ToUnixTimeMilliseconds())" PointColor="e => e.PointColor"
                        OrderByDescending="e => e.Items.First().Team.Name" />
                }

            </ChildContent>


        </ApexChart>
    }

</DemoContainer>



@if (selectedData != null && selectedData.DataPoint != null)
{
    <div class="alert alert-info">
        <h3>Edit:@selectedData.DataPoint.Items.First().Name</h3>
    </div>

    <form>
        <!-- Buttons for editing tasks -->
        
        <button type="button" class="btn btn-primary" @onclick="RemoveTask">Remove Task</button>
        <button type="button" class="btn btn-primary" @onclick="ToggleEditTaskName">Edit Task Name</button>
        <button type="button" class="btn btn-primary" @onclick="ToggleEditTaskTime">Edit Task Time</button>
        <button type="button" class="btn btn-primary" @onclick="ToggleEditTaskComments">Comments</button>
        <button type="button" class="btn btn-primary" @onclick="ToggleEditTaskProgress">Update Progress</button>
        <button type="button" class="btn btn-primary" @onclick="ToggleEditTaskDependencies">Add Dependency</button>
    </form>
    @if (showEditTaskNameInput)
    {
        <EditTaskNameInput selectedData="selectedData" project="project" chart="chart" OnClose="ToggleEditTaskName" />
    }
    @if (showEditTaskTimeInput)
    {
        <EditTaskTimeInput selectedData="selectedData" project="project" chart="chart" OnClose="ToggleEditTaskTime" />
    }
    @if (showEditTaskProgressInput)
    {
        <EditTaskProgressInput selectedData="selectedData" project="project" chart="chart" mileChart="MileChart"
            milestones="milestones" OnClose="ToggleEditTaskProgress" />
    }
    @if (showEditTaskCommentsModal)
    {
        <EditTaskCommentsModal selectedData="selectedData" project="project" chart="chart" OnClose="ToggleEditTaskComments" />
    }

    @if (showEditTaskDependenciesModal)
    {
        <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog" id="addDependenciesModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Manage Dependencies</h5>
                        <button type="button" class="close" @onclick="ToggleEditTaskDependencies">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h5>Current Dependencies:</h5>
                        <div>
                            @foreach (var dependency in selectedData.DataPoint.Items.First().Dependencies)
                            {
                                <div>
                                    <span>@selectedData.DataPoint.Items.First().Name -> @dependency.SuccessorTask.Name|
                                        @dependency.Type </span>
                                    <button type="button" class="btn btn-link"
                                        @onclick="() => DeleteDependency(selectedData.DataPoint.Items.First().Dependencies, dependency)">
                                        Remove
                                    </button>
                                </div>
                            }
                        </div>
                        <hr />
                        <h5>Add a new dependency:</h5>
                        <form>
                            <div class="form-group">
                                <label for="selectedSuccessorTask">Select Task:</label>
                                <select class="form-control" id="selectedSuccessorTask" @bind="selectedSuccessorTask">
                                    <option value="0">-</option>
                                    @foreach (var task in project)
                                    {
                                        if (task.Id != selectedData.DataPoint.Items.First().Id)
                                        {
                                            <option value="@task.Id">@task.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dependencyType">Select Dependency Type:</label>
                                <select class="form-control" id="dependencyType" @bind="selectedDependencyType">
                                    @foreach (var dependencyType in Enum.GetValues(typeof(DependencyType)))
                                    {
                                        <option value="@dependencyType">@dependencyType</option>
                                    }
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="ToggleEditTaskDependencies">Close</button>
                        <button type="button" class="btn btn-success" @onclick="AddDependency">Add Dependency</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
        <div class="modal-backdrop fade show"></div>
    }

    <div class="mt-4">
        <h4>Task Information:</h4>
        <ul class="list-group">
            <li class="list-group-item">Task Name: @selectedData.DataPoint.Items.First().Name</li>
            <li class="list-group-item">Start Date: @selectedData.DataPoint.Items.First().StartDate.ToShortDateString()</li>
            <li class="list-group-item">End Date: @selectedData.DataPoint.Items.First().EndDate.ToShortDateString()</li>
            <li class="list-group-item">Team: @selectedData.DataPoint.Items.First().Team.Name</li>
            <li class="list-group-item">Progress: @selectedData.DataPoint.Items.First().Progress%</li>
            <li class="list-group-item">Task Time Progress: @selectedData.DataPoint.Items.First().AutoProgress%</li>
            <li class="list-group-item">User Progress Difference: @CompareUserProgress(selectedData.DataPoint.Items.First())
            </li>
            <div class="mt-4">
                <h4>Dependencies:</h4>
                <ul class="list-group">
                    @foreach (var dependency in selectedData.DataPoint.Items.First().Dependencies)
                    {
                        <li class="list-group-item">
                            Task: @TaskDataService.GetTaskName(dependency.SuccessorTaskId),
                            Type: @dependency.Type
                        </li>
                    }
                </ul>
            </div>
        </ul>
    </div>

}
else if (selectedData != null)
{
    <div class="alert alert-info">
        <h3>You clicked the chart but not a data point</h3>
    </div>
}

<h3> Add a new task: </h3>

<form>
    <div class="form-group">
        <label for="taskName">Task Name:</label>
        <input class="form-control" type="text" id="taskName" @bind="newTask.Name" />
    </div>

    <div class="form-group">
        <label for="startDate">Start Date:</label>
        <input class="form-control" type="date" id="startDate" @bind="newTask.StartDate" />
    </div>

    <div class="form-group">
        <label for="endDate">End Date:</label>
        <input class="form-control" type="date" id="endDate" @bind="newTask.EndDate" />
    </div>

    <div class="form-group">
        <label for="comments">Comments:</label>
        <input class="form-control" id="comments" @bind="newTask.Comments">
    </div>

    <div class="form-group">
        <label for="taskTeam">Task Team:</label>
        <select class="form-control" id="taskTeam" @bind="selectedTeamName">
            <option value="">-</option>
            @foreach (var team in teams)
            {
                <option value="@team.Name">@team.Name</option>
            }
        </select>

    </div>

    <br>
    <button class="btn btn-primary" type="button" @onclick="AddTask">Add Task</button>
</form>


@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger mt-2">@errorMessage</div>
}


@code {
    private string errorMessage = "";
    private ApexChart<TaskData> chart;
    private TaskData newTask = new TaskData();
    private List<TaskData> project;
    private List<TaskData> sortedTasks;
    private List<ProjectTeam> teams;
    private ApexChartOptions<TaskData> options;
    private SelectedData<TaskData> selectedData;
    private string newTaskName;
    private DateTime newTaskStartTime = DateTime.Today;
    private DateTime newTaskEndTime = DateTime.Today.AddDays(1);
    private string selectedTeamName;
    private TaskData selectedTaskForProgress;
    private bool showEditTaskNameInput = false;
    private bool showEditTaskTimeInput = false;
    private bool showEditTaskProgressInput = false;
    private bool showEditTaskCommentsModal = false;
    private bool showEditTaskDependenciesModal = false;
    private DependencyType selectedDependencyType = DependencyType.FS; //default is FS
    private string selectedSuccessorTaskName;
    private int selectedSuccessorTask = 0;
    private List<object> boxedValues = new List<object>();
    private ApexChart<ProjectMilestone> MileChart;
    private List<ProjectMilestone> milestones;
    private string title = "Milestone List";
    private List<double> lineData;
    private ApexChartOptions<ProjectMilestone> options1 { get; set; } = new();
    private ProjectMilestone clickedMilestone;
    private List<ProjectMilestone> displayedMilestones = new List<ProjectMilestone>();



    protected override async Task OnInitializedAsync()
    {
        project = TaskDataService.GetAllTasks();
        teams = ProjectTeamService.GetAllTeams();
        milestones = MilestoneService.GetAllMilestones();

        sortedTasks = project;
        var colors = teams.Select(team => team.Color).ToList();
        lineData = milestones.Select(_ => 100.0).ToList();

        options1.Yaxis = new List<YAxis>();
        options1.Yaxis.Add(new YAxis
            {
                DecimalsInFloat = 0,
                TickAmount = 1,

                Labels = new YAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        FontSize = "5px",
                        Colors = new Color("white")
                    }
                }
            });


        options = new ApexChartOptions<TaskData>
            {
                PlotOptions = new PlotOptions
                {
                    Bar = new PlotOptionsBar
                    {
                        Horizontal = true,
                        RangeBarGroupRows = true,
                    }
                },
                Tooltip = new ApexCharts.Tooltip
                {
                    X = new TooltipX
                    {
                        Format = "dd MMM yyyy",
                    }
                },
                Colors = colors,

            };

        options.Legend = new Legend { Position = LegendPosition.Bottom, FontSize = "14px", HorizontalAlign = Align.Center };

    }

    private async Task RefreshData()
    {
        project = TaskDataService.GetAllTasks();
        teams = ProjectTeamService.GetAllTeams();
        milestones = MilestoneService.GetAllMilestones();

        StateHasChanged();
    }

    private void OnClick(SelectedData<TaskData> data)
    {
        selectedData = data;
    }

    private Task HandleMilestoneClick(SelectedData<ProjectMilestone> data)
    {
        return ShowMilestone(data);
    }

    private async Task ShowMilestone(SelectedData<ProjectMilestone> data)
    {
        clickedMilestone = data?.DataPoint?.Items?.FirstOrDefault();

        if (clickedMilestone != null)
        {
            if (displayedMilestones.Contains(clickedMilestone))
            {
                displayedMilestones.Remove(clickedMilestone);
                await RedrawAnnotations();
            }
            else
            {
                displayedMilestones.Add(clickedMilestone);
                await RedrawAnnotations();
            }
        }
    }


    private async Task RedrawAnnotations()
    {
        await chart.ClearAnnotationsAsync(); 

        foreach (var milestone in displayedMilestones)
        {

            await AddMilestoneAnnotation(milestone);
        }
    }



    private async Task AddMilestoneAnnotation(ProjectMilestone milestone)
    {
        var XMValue = milestone.TargetDate.ToUnixTimeMilliseconds().ToString();
        var tasksText = string.Join(" ", milestone.Tasks.Select(t =>
        {
            var progressText = (t.Progress == 100) ? "(Complete)" : "";
            return $"{t.Name}{progressText}";
        }));

        var point = new AnnotationsPoint
            {
                X = XMValue,
                Y = 0,
                Label = new Label
                {
                    Text = $"{milestone.Name}: {tasksText}",
                    Style = new Style
                    {
                        FontSize = "17px",
                        Padding = new ApexCharts.Padding { Left = 3, Right = 3, Top = 20, Bottom = 20 },
                    },
                },
            };

        var point2 = new AnnotationsXAxis
            {
                X = XMValue,
                StrokeDashArray = 10,
                BorderWidth = 3,
            };

        await chart.AddXAxisAnnotationAsync(point2, false);
        await chart.AddPointAnnotationAsync(point, false);

    }


    private async Task AddTask()
    {
        try
        {
            if (!newTask.Name.IsTaskNameValid())
            {
                errorMessage = "Task name is required.";
                return;
            }
            if (!newTask.Name.IsValidTaskName())
            {
                errorMessage = "Invalid task name. Only alphanumeric characters and spaces are allowed.";
                return;
            }

            if (!newTask.StartDate.IsEndDateGreaterThanStartDate(newTask.EndDate))
            {
                errorMessage = "End date must be greater than start date.";
                return;
            }

            errorMessage = "";
            var selectedTeam = teams.FirstOrDefault(t => t.Name == selectedTeamName);

            if (selectedTeam != null)
            {
                var newTaskData = new TaskData()
                    {
                        Name = newTask.Name,
                        StartDate = newTask.StartDate,
                        EndDate = newTask.EndDate,
                        TeamId = selectedTeam.Id,
                        Progress = 0,
                        Comments = newTask.Comments
                    };
                TaskDataService.SyncColorWithTeam(newTaskData);
                newTaskData.AutoProgress = (double)CalculateAutoProgress(newTaskData);

                TaskDataService.AddTask(newTaskData);
                project.Add(newTaskData);

                await RefreshData();
                await chart.UpdateSeriesAsync();
            }
            else
            {
                errorMessage = "Selected team not found.";
                throw new UnexpectedDataScenarioException(errorMessage);
            } 
        }
        catch (UnexpectedDataScenarioException ex)
        {
            ExceptionLogger.LogException(ex);
        }
    }

    private double CalculateAutoProgress(TaskData task)
    {
        var now = DateTime.Now;
        double totalDays = (task.EndDate - task.StartDate).TotalDays;
        double dayProgress;

        if (task.StartDate <= now && now <= task.EndDate)
        {
            double daysPassed = (now - task.StartDate).TotalDays;
            dayProgress = (daysPassed / totalDays) * 100;
        }
        else if (now > task.EndDate)
        {
            dayProgress = 100;
        }
        else
        {
            dayProgress = 0;
        }

        return dayProgress;
    }


    public List<T> SortTasksByDependencies<T, U>(List<T> tasks)
        where T : TaskData
        where U : Dependency
    {
        var graph = new Dictionary<int, List<int>>();
        var inDegree = new Dictionary<int, int>();

        // Build the graph and calculate in-degrees
        foreach (var task in tasks)
        {
            graph[task.Id] = new List<int>();
            inDegree[task.Id] = 0;
        }

        foreach (var task in tasks)
        {
            foreach (var dependency in task.Dependencies)
            {
                if (graph.ContainsKey(dependency.SuccessorTaskId) && task.Id != dependency.SuccessorTaskId) // Check if the key exists
                {
                    graph[dependency.SuccessorTaskId].Add(task.Id);
                    inDegree[task.Id]++;
                }
                else
                {
                    // Handle the case where the key doesn't exist (e.g., log or display an error)
                    Console.WriteLine($"Dependency successor task '{dependency.SuccessorTaskId}' not found.");
                }
            }
        }


        var sortedTasks = new List<T>();
        var queue = new Queue<int>(inDegree.Where(entry => entry.Value == 0).Select(entry => entry.Key));

        while (queue.Count > 0)
        {
            var currentTaskId = queue.Dequeue();
            var currentTask = tasks.First(task => (task as TaskData).Id == currentTaskId);

            sortedTasks.Add(currentTask);

            foreach (var dependentTaskId in graph[currentTaskId])
            {
                inDegree[dependentTaskId]--;
                if (inDegree[dependentTaskId] == 0)
                {
                    queue.Enqueue(dependentTaskId);
                }
            }
        }

        return sortedTasks;
    }



    private string CompareUserProgress(TaskData task)
    {
        double userProgress = task.Progress;
        double taskTimeProgress = task.AutoProgress;
        double userDaysAheadOrBehind = (taskTimeProgress - userProgress) * (task.EndDate - task.StartDate).TotalDays / 100.0;

        if (userProgress == 100)
        {
            return "Task completed.";
        }
        else if (userDaysAheadOrBehind > 0)
        {
            return $"User is {userDaysAheadOrBehind:N1} days behind.";
        }
        else if (userDaysAheadOrBehind < 0) { return $"User is {Math.Abs(userDaysAheadOrBehind):N1} days ahead."; }
        else
        {
            return "User is on track.";
        }
    }

    private async Task RemoveTask()
    {
        if (selectedData != null && selectedData.DataPoint != null &&
        selectedData.DataPoint.Items.First().Id is int selectedTaskId)
        { // Use LINQ to create a new list of tasks
            var taskToRemove = project.FirstOrDefault(task => task.Id == selectedTaskId);

            if (taskToRemove != null)
            {
                TaskDataService.RemoveTask(taskToRemove);
            }
        }
        await RefreshData();
        selectedData = null; // Reset selected data after removal
        List<TaskData> sortedTasks = SortTasksByDependencies<TaskData, Dependency>(project);

        project = sortedTasks;

        await RefreshData();
        await chart.UpdateSeriesAsync();
    }

    async void DeleteDependency(List<Dependency> dependencies, Dependency dependency)
    {
        DependencyService.RemoveDependency(dependency);
        await RefreshData();
    }
    private async Task<bool> DetectCycleInternal(TaskData currentTask, TaskData startingTask, HashSet<TaskData> visited,
    HashSet<TaskData> currentlyVisiting)
    {
        if (currentlyVisiting.Contains(currentTask))
        {
            // Cycle detected
            // Console.WriteLine("cycle detected");
            return true;
        }

        if (visited.Contains(currentTask))
        {
            // Already visited, no cycle
            return false;
        }

        currentlyVisiting.Add(currentTask);

        foreach (var dependency in currentTask.Dependencies)
        {
            TaskData successorTask = project.FirstOrDefault(t => t.Id == dependency.SuccessorTaskId);

            if (successorTask != null && await DetectCycleInternal(successorTask, startingTask, visited, currentlyVisiting))
            {
                return true; // Cycle detected in the recursive call
            }
        }

        currentlyVisiting.Remove(currentTask);
        visited.Add(currentTask);

        return false; // No cycle detected
    }

    // Call this function from your AddDependency or wherever appropriate
    private async Task<bool> DetectCycle(TaskData startingTask)
    {
        HashSet<TaskData> visited = new HashSet<TaskData>();
        HashSet<TaskData> currentlyVisiting = new HashSet<TaskData>();

        return await DetectCycleInternal(startingTask, startingTask, visited, currentlyVisiting);
    }

    private async Task AddDependency()
    {
        if (selectedData != null && selectedData.DataPoint != null &&
            selectedData.DataPoint.Items.First().Id is int selectedTaskId)
        {
            TaskData predecessorTask = project.FirstOrDefault(task => task.Id == selectedTaskId);

            if (predecessorTask != null)
            {
                DependencyType dependencyType = selectedDependencyType;
                int  selectedSuccessorTaskId = selectedSuccessorTask;
                // input checks

                if (selectedSuccessorTaskId == 0)
                {
                    return;
                }
                if (predecessorTask.Dependencies.Any(dep => dep.SuccessorTaskId == selectedSuccessorTaskId))
                {
                    Console.WriteLine("loxas");
                    // Display an error message, log, or handle the situation appropriately
                    return;
                }

                if (await DetectCycle(predecessorTask))
                {
                    // Cycle detected, handle the situation appropriately (display error, log, etc.)
                    Console.WriteLine("cycle detected");
                    return;
                }

                // creeaate
                Dependency newDependency = new Dependency
                {
                        PredecessorTaskId = predecessorTask.Id,
                        SuccessorTaskId = selectedSuccessorTaskId,
                        Type = dependencyType
                };

                DependencyService.AddDependency(newDependency);
                predecessorTask.Dependencies.Add(newDependency);

                List<TaskData> sortedTasks = SortTasksByDependencies<TaskData, Dependency>(project);
                TaskManager.Reschedule(predecessorTask, sortedTasks, chart);
                foreach (var task in sortedTasks)
                {
                    Console.WriteLine(task.Name);
                }
                Console.WriteLine("----------");
            }
        }

        selectedSuccessorTaskName = "";
        selectedDependencyType = DependencyType.FS;

        await RefreshData();
        await chart.UpdateSeriesAsync();
    }




    #region ToggleFunctions
    private void ToggleEditTaskName()
    {
        newTaskName = "";
        showEditTaskNameInput = !showEditTaskNameInput;
    }

    private void ToggleEditTaskProgress()
    {
        showEditTaskProgressInput = !showEditTaskProgressInput;
    }


    private void ToggleEditTaskDependencies()
    {
        showEditTaskDependenciesModal = !showEditTaskDependenciesModal;
        selectedSuccessorTaskName = null;

    }

    private void ToggleEditTaskTime()
    {
        newTaskStartTime = DateTime.Today;
        newTaskEndTime = DateTime.Today.AddDays(1);
        showEditTaskTimeInput = !showEditTaskTimeInput;
    }

    private void ToggleEditTaskComments()
    {
        showEditTaskCommentsModal = !showEditTaskCommentsModal;
    }
    #endregion

    private string CheckEstimatedProgress(TaskData task)
    {
        if (task.Progress == 100)
        {
            return "Task " + task.Name + " is already complete.";
        }
        else
        {
            double remainingDays = (task.EndDate - DateTime.Now).TotalDays;

            if (task.Progress >= task.AutoProgress)
            {
                return "Task " + task.Name + " should be finished on time.";
            }
            else
            {
                var team = task.Team;
                int additionalPeopleNeeded = CalculateAdditionalPeople(task, team);
                return "Task " + task.Name + " is behind schedule. Consider adding " + additionalPeopleNeeded + " more people.";
            }
        }
    }

    private int CalculateAdditionalPeople(TaskData task, ProjectTeam team)
    {
        double progressPerPerson = task.Progress / team.Members.Count;
        double progressWithoutOriginalPeople = (100 / task.AutoProgress) * task.Progress;
        double remainingTime = 100 - task.AutoProgress;

        // Assuming all team members contribute equally, calculate the number of additional people needed
        int additionalPeopleNeeded = (int)Math.Ceiling((100 - progressWithoutOriginalPeople) / (remainingTime / task.AutoProgress * progressPerPerson));

        return additionalPeopleNeeded;
    }

}